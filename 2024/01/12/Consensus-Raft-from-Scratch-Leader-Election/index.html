<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>[Consensus] Raft from Scratch: Leader Election - Peter Yuncheng Yao</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Peter&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Peter&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="In this series, I will try to implement the Raft protocol in Golang, using the RPC as a building block. Source code available at https:&amp;#x2F;&amp;#x2F;github.com&amp;#x2F;PeterYaoNYU&amp;#x2F;mit-distributed-sys."><meta property="og:type" content="blog"><meta property="og:title" content="[Consensus] Raft from Scratch: Leader Election"><meta property="og:url" content="http://peteryaonyu.github.io/2024/01/12/Consensus-Raft-from-Scratch-Leader-Election/"><meta property="og:site_name" content="Peter Yuncheng Yao"><meta property="og:description" content="In this series, I will try to implement the Raft protocol in Golang, using the RPC as a building block. Source code available at https:&amp;#x2F;&amp;#x2F;github.com&amp;#x2F;PeterYaoNYU&amp;#x2F;mit-distributed-sys."><meta property="og:locale" content="en_US"><meta property="og:image" content="http://peteryaonyu.github.io/img/og_image.png"><meta property="article:published_time" content="2024-01-12T09:12:17.000Z"><meta property="article:modified_time" content="2024-01-12T12:08:07.746Z"><meta property="article:author" content="Yuncheng Yao"><meta property="article:tag" content="Peter Yuncheng Yao, Peter Yao, Peter Y. Yao, Peter Yao NYU, Peter Yao NYU Shanghai, Peter Yao NYUSH, Peter Yao NYU S"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://peteryaonyu.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://peteryaonyu.github.io/2024/01/12/Consensus-Raft-from-Scratch-Leader-Election/"},"headline":"[Consensus] Raft from Scratch: Leader Election","image":["http://peteryaonyu.github.io/img/og_image.png"],"datePublished":"2024-01-12T09:12:17.000Z","dateModified":"2024-01-12T12:08:07.746Z","author":{"@type":"Person","name":"Yuncheng Yao"},"publisher":{"@type":"Organization","name":"Peter Yuncheng Yao","logo":{"@type":"ImageObject","url":{"text":"Yao Yuncheng(Peter)"}}},"description":"In this series, I will try to implement the Raft protocol in Golang, using the RPC as a building block. Source code available at https:&#x2F;&#x2F;github.com&#x2F;PeterYaoNYU&#x2F;mit-distributed-sys."}</script><link rel="canonical" href="http://peteryaonyu.github.io/2024/01/12/Consensus-Raft-from-Scratch-Leader-Election/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Peter Yuncheng Yao" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Yao Yuncheng(Peter)</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/PeterYaoNYU"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-01-12T09:12:17.000Z" title="1/12/2024, 5:12:17 PM">2024-01-12</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-01-12T12:08:07.746Z" title="1/12/2024, 8:08:07 PM">2024-01-12</time></span><span class="level-item">10 minutes read (About 1556 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">[Consensus] Raft from Scratch: Leader Election</h1><div class="content"><p>In this series, I will try to implement the Raft protocol in Golang, using the RPC as a building block. Source code available at <a target="_blank" rel="noopener" href="https://github.com/PeterYaoNYU/mit-distributed-sys">https://github.com/PeterYaoNYU/mit-distributed-sys</a>. </p>
<span id="more"></span>

<p>To be frank, I am not sure if I am able to finish this project, given the obvious complexity of implementing the Raft algorithm. But we have to at least try. </p>
<p>The choice of Raft over Paxos is mainly out of understanbility: Raft is not necessarily superior to Paxos, but itâ€™s much easier to implement, given that the documentation is much more complete. We are lucky that the author already divided the implementation into separate components, and in this part, we will implement the <em><strong>Leader Election</strong></em> part of the code. </p>
<p>To begin, we need to define the structure of a Raft instance, for originality, I stick to figure 2 in the original paper in terms of naming convention. Note that this is subject to change in subsequent implementation: currently we are only focusing on the Leader Election. We also need to define some structs for the RPC request and reply.  </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// A Go object implementing a single Raft peer.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">type</span> Raft <span class="keyword">struct</span> &#123;</span><br><span class="line">	mu        sync.Mutex          <span class="comment">// Lock to protect shared access to this peer&#x27;s state</span></span><br><span class="line">	peers     []*labrpc.ClientEnd <span class="comment">// RPC end points of all peers</span></span><br><span class="line">	persister *Persister          <span class="comment">// Object to hold this peer&#x27;s persisted state</span></span><br><span class="line">	me        <span class="type">int</span>                 <span class="comment">// this peer&#x27;s index into peers[]</span></span><br><span class="line">	dead      <span class="type">int32</span>               <span class="comment">// set by Kill()</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Your data here (2A, 2B, 2C).</span></span><br><span class="line">	<span class="comment">// Look at the paper&#x27;s Figure 2 for a description of what</span></span><br><span class="line">	<span class="comment">// state a Raft server must maintain.</span></span><br><span class="line"></span><br><span class="line">	applyCh        <span class="keyword">chan</span> ApplyMsg</span><br><span class="line">	applyCond      *sync.Cond</span><br><span class="line">	replicatorCond []*sync.Cond</span><br><span class="line">	state          NodeState</span><br><span class="line"></span><br><span class="line">	currentTerm <span class="type">int</span></span><br><span class="line">	votedFor    <span class="type">int</span></span><br><span class="line">	logs        []Entry</span><br><span class="line"></span><br><span class="line">	commitIndex <span class="type">int</span></span><br><span class="line">	lastApplied <span class="type">int</span></span><br><span class="line">	nextIndex   []<span class="type">int</span></span><br><span class="line">	matchIndex  []<span class="type">int</span></span><br><span class="line"></span><br><span class="line">	electionTimer  *time.Timer</span><br><span class="line">	heartbeatTimer *time.Timer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RequestVoteArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Your data here (2A, 2B).</span></span><br><span class="line">	Term         <span class="type">int</span></span><br><span class="line">	CandidateId  <span class="type">int</span></span><br><span class="line">	LastLogIndex <span class="type">int</span></span><br><span class="line">	LastLogTerm  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// example RequestVote RPC reply structure.</span></span><br><span class="line"><span class="comment">// field names must start with capital letters!</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">type</span> RequestVoteReply <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Your data here (2A).</span></span><br><span class="line">	Term        <span class="type">int</span></span><br><span class="line">	VoteGranted <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Entry <span class="keyword">struct</span> &#123;</span><br><span class="line">	Term    <span class="type">int</span></span><br><span class="line">	Command <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AppendEntriesArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">	Term         <span class="type">int</span></span><br><span class="line">	LeaderId     <span class="type">int</span></span><br><span class="line">	PrevLogIndex <span class="type">int</span></span><br><span class="line">	PrevLogTerm  <span class="type">int</span></span><br><span class="line">	Entries      []Entry</span><br><span class="line">	LeaderCommit <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AppendEntriesReply <span class="keyword">struct</span> &#123;</span><br><span class="line">	Term    <span class="type">int</span></span><br><span class="line">	Success <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Some constants related to heartbeat and leader timeout are as follows, you can change it according to the specific requirement of your distributed system.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	Follower NodeState = <span class="literal">iota</span></span><br><span class="line">	Candidate</span><br><span class="line">	Leader</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	MinElectionTimeout = <span class="number">1300</span> * time.Millisecond</span><br><span class="line">	MaxElectionTimeout = <span class="number">2000</span> * time.Millisecond</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> HeartbeatInterval = <span class="number">100</span> * time.Millisecond</span><br></pre></td></tr></table></figure>

<p>Then we write the initialization code for the Raft instance. The main idea is simple: initialize the varaibles defined in the Raft Struct. </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Make</span><span class="params">(peers []*labrpc.ClientEnd, me <span class="type">int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	persister *Persister, applyCh <span class="keyword">chan</span> ApplyMsg)</span></span> *Raft &#123;</span><br><span class="line">	rf := &amp;Raft&#123;&#125;</span><br><span class="line">	rf.peers = peers</span><br><span class="line">	rf.persister = persister</span><br><span class="line">	rf.me = me</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Your initialization code here (2A, 2B, 2C).</span></span><br><span class="line">	rf.dead = <span class="number">0</span></span><br><span class="line">	rf.applyCh = applyCh</span><br><span class="line">	<span class="comment">// this loc I am not sure about, what is the exact usage of applyCond?</span></span><br><span class="line">	rf.applyCond = sync.NewCond(&amp;rf.mu)</span><br><span class="line">	rf.replicatorCond = <span class="built_in">make</span>([]*sync.Cond, <span class="built_in">len</span>(peers))</span><br><span class="line">	rf.state = Follower</span><br><span class="line">	rf.currentTerm = <span class="number">0</span></span><br><span class="line">	rf.votedFor = <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">	rf.logs = <span class="built_in">make</span>([]Entry, <span class="number">1</span>)</span><br><span class="line">	rf.nextIndex = <span class="built_in">make</span>([]<span class="type">int</span>, <span class="built_in">len</span>(peers))</span><br><span class="line">	rf.matchIndex = <span class="built_in">make</span>([]<span class="type">int</span>, <span class="built_in">len</span>(peers))</span><br><span class="line">	rf.heartbeatTimer = time.NewTimer(HeartbeatInterval)</span><br><span class="line">	rf.electionTimer = time.NewTimer(RandomizedElectionTimeout())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// initialize from state persisted before a crash</span></span><br><span class="line">	rf.readPersist(persister.ReadRaftState())</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;&#123;Node %v&#125; is initialized with state &#123;state %v,term %v,commitIndex %v,lastApplied %v&#125;&quot;</span>, rf.me, rf.state, rf.currentTerm, rf.commitIndex, rf.lastApplied)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// start ticker goroutine to start elections</span></span><br><span class="line">	<span class="keyword">go</span> rf.ticker()</span><br><span class="line"></span><br><span class="line">	fmt.Print(<span class="string">&quot;Raft is initialized\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rf</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After initialization, a ticker will be set off. Its main functions are, in a separate go routine:</p>
<ul>
<li>if is the leader, send regular heartbeat</li>
<li>for all server, set the randomized timeout for the election timer</li>
</ul>
<p>I use 2 go timers to implement that, with the following code:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The ticker go routine starts a new election if this peer hasn&#x27;t received</span></span><br><span class="line"><span class="comment">// heartsbeats recently.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> ticker() &#123;</span><br><span class="line">	<span class="keyword">for</span> !rf.killed() &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-rf.electionTimer.C:</span><br><span class="line">			rf.mu.Lock()</span><br><span class="line">			rf.ChangeState(Candidate)</span><br><span class="line">			rf.currentTerm += <span class="number">1</span></span><br><span class="line">			rf.StartElection()</span><br><span class="line">			rf.electionTimer.Reset(RandomizedElectionTimeout())</span><br><span class="line">			fmt.Printf(<span class="string">&quot;Node %v&#x27;s election timer fires, curremtTerm: %v\n&quot;</span>, rf.me, rf.currentTerm)</span><br><span class="line">			rf.mu.Unlock()</span><br><span class="line">		<span class="keyword">case</span> &lt;-rf.heartbeatTimer.C:</span><br><span class="line">			rf.mu.Lock()</span><br><span class="line">			<span class="keyword">if</span> rf.state == Leader &#123;</span><br><span class="line">				rf.BroadcastHeartbeat(<span class="literal">true</span>)</span><br><span class="line">				rf.heartbeatTimer.Reset(HeartbeatInterval)</span><br><span class="line">			&#125;</span><br><span class="line">			rf.mu.Unlock()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>First, letâ€™s focus on the BroadcastHeartbeat() function, which is easier. It is just sending out regular AppendEntries RPC to all servers except itself:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> BroadcastHeartbeat(includeLogReplication <span class="type">bool</span>) &#123;</span><br><span class="line">	<span class="comment">// rf.mu.Lock()</span></span><br><span class="line">	<span class="comment">// defer rf.mu.Unlock()</span></span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;[BroadcastHeartbeat] &#123;Node %v&#125; broadcasts heartbeat in term %v\n&quot;</span>, rf.me, rf.currentTerm)</span><br><span class="line"></span><br><span class="line">	args := AppendEntriesArgs&#123;</span><br><span class="line">		Term:     rf.currentTerm,</span><br><span class="line">		LeaderId: rf.me,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> peerIndex, _ := <span class="keyword">range</span> rf.peers &#123;</span><br><span class="line">		<span class="keyword">if</span> peerIndex == rf.me &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(peerIndex <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">			reply := AppendEntriesReply&#123;&#125;</span><br><span class="line">			ok := rf.CallAppendEntries(peerIndex, &amp;args, &amp;reply)</span><br><span class="line">			rf.mu.Lock()</span><br><span class="line">			<span class="keyword">defer</span> rf.mu.Unlock()</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> ok &#123;</span><br><span class="line">				<span class="keyword">if</span> reply.Term &gt; rf.currentTerm &#123;</span><br><span class="line">					fmt.Printf(<span class="string">&quot;[Heartbeat Receive] &#123;Node %v&#125; receives Heartbeat reply gtom &#123;Node %v&#125; with term %v and steps down in term %v&quot;</span>, rf.me, peerIndex, reply.Term, rf.currentTerm)</span><br><span class="line">					rf.ChangeState(Follower)</span><br><span class="line">					rf.currentTerm = reply.Term</span><br><span class="line">					rf.votedFor = <span class="number">-1</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				fmt.Printf(<span class="string">&quot;&#123;Node %v&#125; fails to send AppendEntriesRequest %v to &#123;Node %v&#125;&quot;</span>, rf.me, args, peerIndex)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;(peerIndex)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> CallAppendEntries(server <span class="type">int</span>, args *AppendEntriesArgs, reply *AppendEntriesReply) <span class="type">bool</span> &#123;</span><br><span class="line">	ok := rf.peers[server].Call(<span class="string">&quot;Raft.AppendEntries&quot;</span>, args, reply)</span><br><span class="line">	<span class="keyword">return</span> ok</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> AppendEntries(args *AppendEntriesArgs, reply *AppendEntriesReply) &#123;</span><br><span class="line">	rf.mu.Lock()</span><br><span class="line">	<span class="keyword">defer</span> rf.mu.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> args.Term &lt; rf.currentTerm &#123;</span><br><span class="line">		reply.Term, reply.Success = rf.currentTerm, <span class="literal">false</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> args.Term &gt; rf.currentTerm &#123;</span><br><span class="line">		rf.ChangeState(Follower)</span><br><span class="line">		rf.currentTerm = args.Term</span><br><span class="line">		rf.votedFor = <span class="number">-1</span></span><br><span class="line">		fmt.Printf(<span class="string">&quot;[Heartbeat + Follower Change] &#123;Node %v&#125; receives heartbeat from &#123;Node %v&#125; in term %v\n&quot;</span>, rf.me, args.LeaderId, rf.currentTerm)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;[Heartbeat] &#123;Node %v&#125; receives heartbeat from &#123;Node %v&#125; in term %v\n&quot;</span>, rf.me, args.LeaderId, rf.currentTerm)</span><br><span class="line">	rf.electionTimer.Reset(RandomizedElectionTimeout())</span><br><span class="line">	reply.Term, reply.Success = rf.currentTerm, <span class="literal">true</span></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note that the append entries function is incomplete, since we havenâ€™t added log replication yet.</p>
<p>Next, letâ€™s implement the voting procedure. The basic logic is that:<br>Once a vote request is received:</p>
<ul>
<li>check if the term number of the request is too stale. If so, turn down the request. </li>
<li>if my term number is too stale, if so, update my term number</li>
<li>if the new leader-to-beâ€™s log is up to date. If so, vote for this leader.</li>
</ul>
<p>An implementation of this looks as follows:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> RequestVote(request *RequestVoteArgs, response *RequestVoteReply) &#123;</span><br><span class="line">	<span class="comment">// Your code here (2A, 2B).</span></span><br><span class="line">	rf.mu.Lock()</span><br><span class="line">	<span class="keyword">defer</span> rf.mu.Unlock()</span><br><span class="line">	<span class="comment">// defer fmt.Printf(&quot;&#123;Node %v&#125;&#x27;s state is &#123;state %v,term %v,commitIndex %v,lastApplied %v,firstLog %v,lastLog %v&#125; before processing requestVoteRequest %v and reply requestVoteResponse %v&quot;, rf.me, rf.state, rf.currentTerm, rf.commitIndex, rf.lastApplied, rf.getFirstLog(), rf.getLastLog(), request, response)</span></span><br><span class="line">	<span class="keyword">defer</span> fmt.Printf(<span class="string">&quot;[RequestVote]&#123;Node %v&#125;&#x27;s state is &#123;state %v,term %v,commitIndex %v,lastApplied %v&#125; before processing requestVoteRequest %v and reply requestVoteResponse %v\n&quot;</span>, rf.me, rf.state, rf.currentTerm, rf.commitIndex, rf.lastApplied, request, response)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> request.Term &lt; rf.currentTerm || (request.Term == rf.currentTerm &amp;&amp; rf.votedFor != <span class="number">-1</span> &amp;&amp; rf.votedFor != request.CandidateId) &#123;</span><br><span class="line">		response.Term = rf.currentTerm</span><br><span class="line">		response.VoteGranted = <span class="literal">false</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> request.Term &gt; rf.currentTerm &#123;</span><br><span class="line">		rf.ChangeState(Follower)</span><br><span class="line">		rf.currentTerm = request.Term</span><br><span class="line">		rf.votedFor = <span class="number">-1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !rf.LogIsUpToDate(request.LastLogTerm, request.LastLogIndex) &#123;</span><br><span class="line">		response.Term = rf.currentTerm</span><br><span class="line">		response.VoteGranted = <span class="literal">false</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	rf.votedFor = request.CandidateId</span><br><span class="line">	rf.electionTimer.Reset(RandomizedElectionTimeout())</span><br><span class="line">	response.Term, response.VoteGranted = rf.currentTerm, <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If the election timer times out, then a follower also changes to a candidate, and send out request asking for votes from a majority. The key idea of the implementation is to do that in a non-blocking manner. Start a separate go routine for each vote request, so that the thread is not blocker waiting for a particular request. Meanwhile, the term number also needs to be checked to ensure that the candidate itself is a viable candidate, i.e., it is not outdated. If through the RPC request, the node finds itself outdated, it just make itself a follower:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> StartElection() &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;StartElection: Node %v\n&quot;</span>, rf.me)</span><br><span class="line">	request := rf.generateRequestVoteRequest()</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Node %v generates RequestVoteRequest %v in term %v\n&quot;</span>, rf.me, request, rf.currentTerm)</span><br><span class="line">	grantedVotes := <span class="number">1</span></span><br><span class="line">	rf.votedFor = rf.me</span><br><span class="line">	<span class="keyword">for</span> peer := <span class="keyword">range</span> rf.peers &#123;</span><br><span class="line">		<span class="keyword">if</span> peer == rf.me &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(peer <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;LOCK: Node %v sending to %v\n&quot;</span>, rf.me, peer)</span><br><span class="line">			response := <span class="built_in">new</span>(RequestVoteReply)</span><br><span class="line">			<span class="keyword">if</span> rf.sendRequestVote(peer, request, response) &#123;</span><br><span class="line">				rf.mu.Lock()</span><br><span class="line">				<span class="keyword">defer</span> rf.mu.Unlock()</span><br><span class="line">				fmt.Printf(<span class="string">&quot;[StartElection] &#123;Node %v&#125; receives RequestVoteResponse %v from &#123;Node %v&#125; after sending RequestVoteRequest %v in term %v\n&quot;</span>, rf.me, response, peer, request, rf.currentTerm)</span><br><span class="line">				<span class="keyword">if</span> rf.currentTerm == request.Term &amp;&amp; rf.state == Candidate &#123;</span><br><span class="line">					<span class="keyword">if</span> response.VoteGranted &#123;</span><br><span class="line">						grantedVotes += <span class="number">1</span></span><br><span class="line">						<span class="keyword">if</span> grantedVotes &gt; <span class="built_in">len</span>(rf.peers)/<span class="number">2</span> &#123;</span><br><span class="line">							fmt.Printf(<span class="string">&quot;&#123;Node %v&#125; receives majority votes in term %v\n&quot;</span>, rf.me, rf.currentTerm)</span><br><span class="line">							rf.ChangeState(Leader)</span><br><span class="line">							rf.BroadcastHeartbeat(<span class="literal">true</span>)</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> response.Term &gt; rf.currentTerm &#123;</span><br><span class="line">					fmt.Printf(<span class="string">&quot;&#123;Node %v&#125; finds a new leader &#123;Node %v&#125; with term %v and steps down in term %v&quot;</span>, rf.me, peer, response.Term, rf.currentTerm)</span><br><span class="line">					rf.ChangeState(Follower)</span><br><span class="line">					rf.currentTerm = response.Term</span><br><span class="line">					rf.votedFor = <span class="number">-1</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;(peer)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;UNLOCK: Node %v finishes StartElection\n&quot;</span>, rf.me)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This concludes the leader election part of Raft. For specific functions whose implementation is not documented in the page, please refer back to the source code. </p>
</div><div class="article-licensing box"><div class="licensing-title"><p>[Consensus] Raft from Scratch: Leader Election</p><p><a href="http://peteryaonyu.github.io/2024/01/12/Consensus-Raft-from-Scratch-Leader-Election/">http://peteryaonyu.github.io/2024/01/12/Consensus-Raft-from-Scratch-Leader-Election/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Yuncheng Yao</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2024-01-12</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2024-01-12</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2024/01/13/Database-Implementation-of-an-Entendible-Hash-Index/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">{Database} Implementation of an Entendible Hash Index</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/01/09/Implementing-a-MapReduce-Framework-with-Golang-from-scratch/"><span class="level-item">Implementing a MapReduce Framework with Golang RPC from scratch</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/images/avatar.jpg" alt="Yao Yuncheng (Peter)"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Yao Yuncheng (Peter)</p><p class="is-size-6 is-block">yy4108@nyu.edu</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shanghai</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">2</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/PeterYaoNYU" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/PeterYaoNYU"><i class="fab fa-github"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-13T14:36:41.000Z">2024-01-13</time></p><p class="title"><a href="/2024/01/13/Database-Implementation-of-an-Entendible-Hash-Index/">{Database} Implementation of an Entendible Hash Index</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-12T09:12:17.000Z">2024-01-12</time></p><p class="title"><a href="/2024/01/12/Consensus-Raft-from-Scratch-Leader-Election/">[Consensus] Raft from Scratch: Leader Election</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-09T04:21:48.000Z">2024-01-09</time></p><p class="title"><a href="/2024/01/09/Implementing-a-MapReduce-Framework-with-Golang-from-scratch/">Implementing a MapReduce Framework with Golang RPC from scratch</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-12-19T00:18:38.000Z">2023-12-19</time></p><p class="title"><a href="/2023/12/19/Database-Bustub-Buffer-Pool-Manager-Implementation/">[Database] Bustub Buffer Pool Manager Implementation</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-10T13:48:33.000Z">2023-07-10</time></p><p class="title"><a href="/2023/07/10/cmu15-213-attack-lab/">CMU15-213 Attack Lab</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/"><span class="level-start"><span class="level-item">2024</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Distribute-Systems/"><span class="tag">Distribute Systems</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Operating-Systems/"><span class="tag">Operating Systems</span><span class="tag">2</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Yao Yuncheng(Peter)</a><p class="is-size-7"><span>&copy; 2024 Yuncheng Yao</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">Â© 2023</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/PeterYaoNYU"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>