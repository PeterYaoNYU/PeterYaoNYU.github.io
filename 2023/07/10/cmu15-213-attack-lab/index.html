<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>CMU15-213 Attack Lab - Peter Yuncheng Yao</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Peter&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Peter&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="It’s been a while since I wrote posts about CMU’s renowned system course 15-213. Last month, I was primarily devoted to my research on SmartNICs and ML for failure detection, and traveling.  Let’s beg"><meta property="og:type" content="blog"><meta property="og:title" content="CMU15-213 Attack Lab"><meta property="og:url" content="http://peteryaonyu.github.io/2023/07/10/cmu15-213-attack-lab/"><meta property="og:site_name" content="Peter Yuncheng Yao"><meta property="og:description" content="It’s been a while since I wrote posts about CMU’s renowned system course 15-213. Last month, I was primarily devoted to my research on SmartNICs and ML for failure detection, and traveling.  Let’s beg"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-10-at-21.50.11-1024x681.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-10-at-21.52.03-1024x681.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-10-at-21.56.46-1024x591.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-10-at-22.00.24-1024x591.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-10-at-22.05.32-1024x591.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-10-at-22.14.35-1024x591.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-11-at-11.22.44-1024x921.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-11-at-11.24.29-1024x94.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-11-at-11.36.16-1024x591.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-11-at-11.41.42-1024x591.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-11-at-11.44.15-1024x591.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-13.59.03-1024x591.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-14.01.33-1024x591.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-16.59.03-1024x455.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-16.59.11-1024x777.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-17.09.59-1024x339.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-17.15.42-1024x653.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-17.27.08-1024x653.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-17.28.52-1024x177.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-17.30.37-1024x185.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-17.37.40-1024x653.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-17.40.17-1024x653.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-18.10.25-1024x653.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.24.57-1024x457.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.25.17-819x1024.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.26.24-1024x581.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.29.16-1024x453.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.30.28-1024x653.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.30.57-1024x653.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.41.01-1024x653.png"><meta property="og:image" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.41.27-1024x653.png"><meta property="article:published_time" content="2023-07-10T13:48:33.000Z"><meta property="article:modified_time" content="2024-01-09T05:54:56.419Z"><meta property="article:author" content="Yuncheng Yao"><meta property="article:tag" content="Operating Systems"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://peteryaonyu.github.io/images/Screenshot-2023-07-10-at-21.50.11-1024x681.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://peteryaonyu.github.io/2023/07/10/cmu15-213-attack-lab/"},"headline":"CMU15-213 Attack Lab","image":["http://peteryaonyu.github.io/images/Screenshot-2023-07-10-at-21.50.11-1024x681.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-10-at-21.52.03-1024x681.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-10-at-21.56.46-1024x591.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-10-at-22.00.24-1024x591.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-10-at-22.05.32-1024x591.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-10-at-22.14.35-1024x591.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-11-at-11.22.44-1024x921.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-11-at-11.24.29-1024x94.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-11-at-11.36.16-1024x591.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-11-at-11.41.42-1024x591.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-11-at-11.44.15-1024x591.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-13.59.03-1024x591.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-14.01.33-1024x591.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-16.59.03-1024x455.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-16.59.11-1024x777.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-17.09.59-1024x339.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-17.15.42-1024x653.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-17.27.08-1024x653.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-17.28.52-1024x177.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-17.30.37-1024x185.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-17.37.40-1024x653.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-17.40.17-1024x653.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-18.10.25-1024x653.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.24.57-1024x457.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.25.17-819x1024.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.26.24-1024x581.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.29.16-1024x453.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.30.28-1024x653.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.30.57-1024x653.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.41.01-1024x653.png","http://peteryaonyu.github.io/images/Screenshot-2023-07-16-at-19.41.27-1024x653.png"],"datePublished":"2023-07-10T13:48:33.000Z","dateModified":"2024-01-09T05:54:56.419Z","author":{"@type":"Person","name":"Yuncheng Yao"},"publisher":{"@type":"Organization","name":"Peter Yuncheng Yao","logo":{"@type":"ImageObject","url":{"text":"Yao Yuncheng(Peter)"}}},"description":"It’s been a while since I wrote posts about CMU’s renowned system course 15-213. Last month, I was primarily devoted to my research on SmartNICs and ML for failure detection, and traveling.  Let’s beg"}</script><link rel="canonical" href="http://peteryaonyu.github.io/2023/07/10/cmu15-213-attack-lab/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Peter Yuncheng Yao" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Yao Yuncheng(Peter)</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/PeterYaoNYU"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-07-10T13:48:33.000Z" title="7/10/2023, 9:48:33 PM">2023-07-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-01-09T05:54:56.419Z" title="1/9/2024, 1:54:56 PM">2024-01-09</time></span><span class="level-item">13 minutes read (About 1892 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">CMU15-213 Attack Lab</h1><div class="content"><p>It’s been a while since I wrote posts about CMU’s renowned system course 15-213. Last month, I was primarily devoted to my research on SmartNICs and ML for failure detection, and traveling. </p>
<p>Let’s begin phase by phase.</p>
<span id="more"></span>





<p>Logistics</p>
<p>The writeup of this lab can be found <a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/attacklab.pdf">here</a> (the CS:APP website). You can <a href="/images/attacklab.pdf">download it from this blog</a> as well.</p>
<p>The target file can be downloaded from my website as well. Open that using linux tar, or you may change the permissions of the file.</p>
<p><a href="/images/target1.tar">target1</a><a href="/images/target1.tar">Download</a></p>
<p>According to my experience, this lab does not work on virtual machines. Bare metal Ubuntu is preferred. I use NYU server instead. </p>
<p><img src="/images/Screenshot-2023-07-10-at-21.50.11-1024x681.png">Not working on my multi-tenant cloud server</p>
<p><img src="/images/Screenshot-2023-07-10-at-21.52.03-1024x681.png">Working on NYU bare metal Ubuntu20 server</p>
<p>Non-CMU student, when running the code, should add a <em><strong>-q</strong></em> flag, so that the program will not try to contact the grading service and then failed. </p>
<p><strong>Phase 1: Simple Buffer Overflow Attack</strong></p>
<p>Phase 1 is a very simple buffer overflow attack, and its main idea was went through during the lecture. </p>
<p>First use <em><strong>objdump -d</strong></em> to get the disassembled file, can be .txt or .asm. Then check the disas file. </p>
<p><img src="/images/Screenshot-2023-07-10-at-21.56.46-1024x591.png"></p>
<p>Use Vim to search for <test>, we find the main logic of phase 1. It calls <getbuf> and then returns. We want to change the return address so that when the execution returns from <getbuf>, it will be redirected to the <touch1> function.</p>
<p><img src="/images/Screenshot-2023-07-10-at-22.00.24-1024x591.png"><touch1> function has an address of 0x00 00 00 00 00 40 17 c0, and we want to jump to it. </p>
<p>To inject the malicious return address, we first need to know how much buffer the <getbuf> function has allocated. I suggest that you take <em><strong>GDB</strong></em> as your most loyal friend. </p>
<p><img src="/images/Screenshot-2023-07-10-at-22.05.32-1024x591.png"></p>
<p><strong>Ok, so the <getbuf> allocated 0x28 bytes, which in decimal is 40 bytes. So we first need to fill the 40 bytes buffer with random input, and then the address of the desired function. Remember that the <getbuf> function fills the stack from the smaller address to the bigger one. So it starts filling from the lower right corner to the upper left corner. However, when the program is reading the return address, it reads from the bigger address to the smaller one (reverse direction). With that being said, the injection string could look something like this:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">c0 17 40 00</span><br><span class="line">00 00 00 00</span><br></pre></td></tr></table></figure>



<p><img src="/images/Screenshot-2023-07-10-at-22.14.35-1024x591.png"></p>
<p>Try it, works as expected.</p>
<p><strong>Phase 2: Code injection</strong></p>
<p>This level is a lot more interesting, I have got to say. The biggest challenge for me is to recall the fact that stack grows downwards (from bigger virtual addresses to smaller ones), while the binary code is executed bottom up (from smaller virtual addresses to bigger ones). So remember that in phase 1 we need to reverse the order of out input so that the malicious return address is in the correct order? In this phase, now that we are directly injecting malicious code, we do not need to reverse the order of the code, since they are executed bottom up, in accordance with the order that <getbuf> gets the input from the user, which is also bottom up. However, we still need to reverse the order of the intended virtual addresses, since the input order is the opposite of the way return address is read by the operating system. </p>
<p>Forgive me for speaking too much without giving you an idea what we are doing here. </p>
<p><img src="/images/Screenshot-2023-07-11-at-11.22.44-1024x921.png"></p>
<p>In this level, we need to redirect the return address of the program to <touch2> but at the same time change the first parameter register %rdi to have value in our cookie.txt, which in our case has the value:</p>
<p><img src="/images/Screenshot-2023-07-11-at-11.24.29-1024x94.png"></p>
<p>Sounds challenging, right?</p>
<p>The basic idea is that: first we need to change the return address after the <getbuf> procedure to somewhere on the stack (in this question, stack execution protection is disabled), that somewhere should be the place where we input our malicious code, which is the 40 bytes buffer of the <getbuf> function. For convenience, I will just set the return address to the bottom of the stack when the <getbuf> is called, namely the start of the 40 bytes buffer. </p>
<p>Then we need to think about what code we would like to put in the stack we were given. I propose something like this, in assembly of course:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov $0x5561dc98, %rdi</span><br><span class="line">pushq $0x000000004017ec</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>



<p>The first line puts the cookie into the register that holds the parameter value for procedure <touch2>. The second line push a return address to the stack, and pushq command will also automatically decrement the stack pointer by 8, so that when we execute ret command in the third line, the stack pointer will increment by 8 automatically, and pop the return address out. This 0x4017ec address points to the <touch2> procedure, which can be found out here:</p>
<p><img src="/images/Screenshot-2023-07-11-at-11.36.16-1024x591.png"></p>
<p>The last piece of this puzzle is, what should the return address of the <getbuf> function be changed to? We want to change it to the beginning of our malicious injected code, which we inject starting at the lowest address of the 40 byte buffer. The answer is self-evident, we need to change the return address to the lowest address of the buffer, and the code will be then executed from bottom up. </p>
<p>So what is this lowest address? I suggest GDB again, your most faithful friend with Linux. </p>
<p><img src="/images/Screenshot-2023-07-11-at-11.41.42-1024x591.png"></p>
<p>The answer is here, 0x5561dc78!</p>
<p>One last step before putting everything together. What is the binary representation of the assembly that we are injecting? To find out, first compile this assembly, and then objdump -d the output to find out. </p>
<p><img src="/images/Screenshot-2023-07-11-at-11.44.15-1024x591.png"></p>
<p>Putting everything together, here is what we should input </p>
<p><img src="/images/Screenshot-2023-07-16-at-13.59.03-1024x591.png"></p>
<p><img src="/images/Screenshot-2023-07-16-at-14.01.33-1024x591.png">this is indeed a valid answer for level 2 of the lab.</p>
<p><strong>Phase 3: Advanced Code Injection</strong></p>
<p>This phase is quite formidable, I have got to admit. Let’s first check out the requirement of the question, it gives us a lot of useful hints.</p>
<p><img src="/images/Screenshot-2023-07-16-at-16.59.03-1024x455.png"></p>
<p><img src="/images/Screenshot-2023-07-16-at-16.59.11-1024x777.png"></p>
<p>The code snippet is not entirely easy to understand, because it does seem a little bit whimsical. If you were able to break down the requirement, here is what we need to do:</p>
<ol start="2">
<li><p>jump to <touch3>, which is at address 0x4018fa of the virtual address space</p>
</li>
<li><p>pass the address of the ASCII representation of our cookie to register %rdi, which serves as a parameter when we call the procedure <hexmatch>.</p>
</li>
<li><p>Figure out a safe place within the stack to store the ASCII representation of our cookie, because some portion of the stack may be overwritten by the the code from <hexmatch></p>
</li>
</ol>
<p>It is observable that we first need to figure out (3), i.e. a safe place that will not be overwritten, then figure out the code we inject to the buffer. </p>
<p>So what is the ASCII representation of the cookie, which for us is 0x59b997fa? How many bytes of space do we need to store the ASCII representation of it?</p>
<p><img src="/images/Screenshot-2023-07-16-at-17.09.59-1024x339.png"></p>
<p>It seems that we need 8 bytes of space, and the ASCII code is 35 39 62 39 39 37 66 61.</p>
<p>So which place is safe to store these 8 bytes? In other words, which part of the stack will be overwritten when we call <hexmatch>? GDB will tell us. </p>
<p><img src="/images/Screenshot-2023-07-16-at-17.15.42-1024x653.png"></p>
<p>First, try this input, then check how much of the 11111…1111 buffer space is changed by hexmatch in GDB. The return address is changed by buffer overflow to <touch3> so that we can observe the behavior of <hexmatch>. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># convert hex to raw hex</span><br><span class="line">./hex2raw &lt; p3\_test.txt &gt; p3\_test\_raw.txt</span><br><span class="line"># GDB COMMAND</span><br><span class="line">gdb --args ./ctarget -q</span><br><span class="line">b test</span><br><span class="line">run -q &lt; p3\_test\_raw.txt</span><br><span class="line"># inspect the first 80 bytes starting at a certain address, in hex</span><br><span class="line">x/20x 0x5561dc78</span><br></pre></td></tr></table></figure>



<p><img src="/images/Screenshot-2023-07-16-at-17.27.08-1024x653.png"></p>
<p>now that we are in <touch3>, make a breakpoint before and after <hexmatch> to see how much of the buffer has been changed. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b \*0x040190b</span><br><span class="line">(gdb) b \*0x0401916</span><br></pre></td></tr></table></figure>



<p><img src="/images/Screenshot-2023-07-16-at-17.28.52-1024x177.png">this is the buffer layout before calling <hexmatch></p>
<p><img src="/images/Screenshot-2023-07-16-at-17.30.37-1024x185.png">this is the buffer layout after calling <hexmatch></p>
<p>we can see that all 40 bytes have been overwritten. So we have to buffer overflow more, and store the address of the ASCII code at someplace after. Address starting at 0x5561dca8 seems unchanged after calling <hexmatch>, and is thus a valid candidate. </p>
<p>So we want to overflow more than the typical 48 bytes. We want at least 56 bytes, and the last 8 bytes are for the ASCII.</p>
<p>Then we need to translate the code using the same technique: write the code, gcc -c, objdump -d</p>
<p><img src="/images/Screenshot-2023-07-16-at-17.37.40-1024x653.png"></p>
<p>You see that we store the address of the ASCII to $rdi, change the return address to <touch3> and then return. </p>
<p>We put the code at the beginning of the buffer, so the return address of <getbuf> should also be changed to 0x5561dc78</p>
<p>Putting everything together, here is the injection code:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">48 c7 c7 a8</span><br><span class="line">dc 61 55 68</span><br><span class="line">fa 18 40 00</span><br><span class="line">c3 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">78 dc 61 55</span><br><span class="line">00 00 00 00</span><br><span class="line">35 39 62 39</span><br><span class="line">39 37 66 61</span><br></pre></td></tr></table></figure>



<p><img src="/images/Screenshot-2023-07-16-at-17.40.17-1024x653.png"></p>
<p>test it, it is indeed the answer. </p>
<p><img src="/images/Screenshot-2023-07-16-at-18.10.25-1024x653.png"></p>
<p><strong>Phase 4: Return-Oriented Attacks</strong></p>
<p>This phase is quite easy, takes around 20 minutes to solve (the previous phase takes me hours…)</p>
<p>The key idea is to understand how to use return-oriented programming to inject malicious code. I think that the lab write-up did a pretty decent job, so let me just quote here. </p>
<p><img src="/images/Screenshot-2023-07-16-at-19.24.57-1024x457.png"></p>
<p><img src="/images/Screenshot-2023-07-16-at-19.25.17-819x1024.png"></p>
<p>The main difficulty then is to find the appropriate code segments and piece them together. </p>
<p><img src="/images/Screenshot-2023-07-16-at-19.26.24-1024x581.png"></p>
<p>here is the requirement for this phase. If you are logical enough, here is the stuff that we need to do:</p>
<ol start="2">
<li><p>use popq instruction to put the cookie to %rdi</p>
</li>
<li><p>then jump to the procedure <touch2></p>
</li>
</ol>
<p><img src="/images/Screenshot-2023-07-16-at-19.29.16-1024x453.png"></p>
<p>As hinted by the author, here we only use popq and movq. Two gadgets are enough. Now let us take a look at the gadgets available!</p>
<p><img src="/images/Screenshot-2023-07-16-at-19.30.28-1024x653.png"></p>
<p><img src="/images/Screenshot-2023-07-16-at-19.30.57-1024x653.png"></p>
<p>We can only use the first 8 gadgets, from the &lt;start_farm&gt; to the &lt;mid_farm&gt;. Apparently, we need a popq to pop the cookie to a certain register, so we are looking for anything from 58 to 5f.</p>
<p>You can choose either &lt;getval_280&gt; or &lt;addval_219&gt;, which contains </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">58 90 c3 </span><br><span class="line">// popq %rax</span><br></pre></td></tr></table></figure>



<p>Note that there is no 5f in the code snippet farm, so we cannot pop directly to %rdi. We can however, later move the content from %rax to %rdi. So we are looking for 48 89 c7. &lt;setval_426&gt; provide the segment for that. </p>
<p>I choose &lt;getval_280&gt; and &lt;setval_426&gt;, the first at 0x4019cc, and the latter at 0x4019c5. The <touch2> function is at address 0x4017ec. Putting everything together, we now want the stack to have the following layout, the code bottom being the top of the stack:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">00 00 00 00</span><br><span class="line">00 40 17 ec // touch2 address</span><br><span class="line">00 00 00 00</span><br><span class="line">00 40 19 c5 // mov from %rax to %rdi</span><br><span class="line">00 00 00 00</span><br><span class="line">59 b9 97 fa // my cookie</span><br><span class="line">00 00 00 00</span><br><span class="line">00 40 19 cc // pop to %rax</span><br><span class="line">...... 40 bytes random (the original &lt;getbuf&gt; buffer)</span><br></pre></td></tr></table></figure>



<p>in order to achieve that layout, we want out input to be </p>
<p><img src="/images/Screenshot-2023-07-16-at-19.41.01-1024x653.png"></p>
<p><img src="/images/Screenshot-2023-07-16-at-19.41.27-1024x653.png"></p>
<p>Test it out, and it is indeed the answer. </p>
<p><strong>Phase5</strong> </p>
</div><div class="article-licensing box"><div class="licensing-title"><p>CMU15-213 Attack Lab</p><p><a href="http://peteryaonyu.github.io/2023/07/10/cmu15-213-attack-lab/">http://peteryaonyu.github.io/2023/07/10/cmu15-213-attack-lab/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Yuncheng Yao</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2023-07-10</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2024-01-09</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Operating-Systems/">Operating Systems</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2023/12/19/Database-Bustub-Buffer-Pool-Manager-Implementation/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">[Database] Bustub Buffer Pool Manager Implementation</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2023/05/18/bomb-lab-cmu-15-213/"><span class="level-item">Bomb Lab CMU 15-213</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/images/avatar.jpg" alt="Yao Yuncheng (Peter)"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Yao Yuncheng (Peter)</p><p class="is-size-6 is-block">yy4108@nyu.edu</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shanghai</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">2</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/PeterYaoNYU" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/PeterYaoNYU"><i class="fab fa-github"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-13T14:36:41.000Z">2024-01-13</time></p><p class="title"><a href="/2024/01/13/Database-Implementation-of-an-Entendible-Hash-Index/">{Database} Implementation of an Entendible Hash Index</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-12T09:12:17.000Z">2024-01-12</time></p><p class="title"><a href="/2024/01/12/Consensus-Raft-from-Scratch-Leader-Election/">[Consensus] Raft from Scratch: Leader Election</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-09T04:21:48.000Z">2024-01-09</time></p><p class="title"><a href="/2024/01/09/Implementing-a-MapReduce-Framework-with-Golang-from-scratch/">Implementing a MapReduce Framework with Golang RPC from scratch</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-12-19T00:18:38.000Z">2023-12-19</time></p><p class="title"><a href="/2023/12/19/Database-Bustub-Buffer-Pool-Manager-Implementation/">[Database] Bustub Buffer Pool Manager Implementation</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-10T13:48:33.000Z">2023-07-10</time></p><p class="title"><a href="/2023/07/10/cmu15-213-attack-lab/">CMU15-213 Attack Lab</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/"><span class="level-start"><span class="level-item">2024</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Distribute-Systems/"><span class="tag">Distribute Systems</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Operating-Systems/"><span class="tag">Operating Systems</span><span class="tag">2</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Yao Yuncheng(Peter)</a><p class="is-size-7"><span>&copy; 2024 Yuncheng Yao</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2023</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/PeterYaoNYU"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>