<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>CMU15-213 Attack Lab | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="CS:APP  It’s been a while since I wrote posts about CMU’s renowned system course 15-213. Last month, I was primarily devoted to my research on SmartNICs and ML for failure detection, and traveling.  L">
<meta property="og:type" content="article">
<meta property="og:title" content="CMU15-213 Attack Lab">
<meta property="og:url" content="http://example.com/2023/07/10/cmu15-213-attack-lab/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="CS:APP  It’s been a while since I wrote posts about CMU’s renowned system course 15-213. Last month, I was primarily devoted to my research on SmartNICs and ML for failure detection, and traveling.  L">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/csapp-jpeg.webp">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-10-at-21.50.11-1024x681.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-10-at-21.52.03-1024x681.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-10-at-21.56.46-1024x591.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-10-at-22.00.24-1024x591.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-10-at-22.05.32-1024x591.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-10-at-22.14.35-1024x591.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-11-at-11.22.44-1024x921.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-11-at-11.24.29-1024x94.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-11-at-11.36.16-1024x591.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-11-at-11.41.42-1024x591.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-11-at-11.44.15-1024x591.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-13.59.03-1024x591.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-14.01.33-1024x591.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-16.59.03-1024x455.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-16.59.11-1024x777.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-17.09.59-1024x339.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-17.15.42-1024x653.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-17.27.08-1024x653.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-17.28.52-1024x177.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-17.30.37-1024x185.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-17.37.40-1024x653.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-17.40.17-1024x653.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-18.10.25-1024x653.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.24.57-1024x457.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.25.17-819x1024.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.26.24-1024x581.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.29.16-1024x453.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.30.28-1024x653.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.30.57-1024x653.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.41.01-1024x653.png">
<meta property="og:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.41.27-1024x653.png">
<meta property="article:published_time" content="2023-07-10T13:48:33.000Z">
<meta property="article:modified_time" content="2023-12-15T12:55:09.292Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yaoyuncheng.site/wp-content/uploads/2023/07/csapp-jpeg.webp">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-cmu15-213-attack-lab" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/07/10/cmu15-213-attack-lab/" class="article-date">
  <time class="dt-published" datetime="2023-07-10T13:48:33.000Z" itemprop="datePublished">2023-07-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      CMU15-213 Attack Lab
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/csapp-jpeg.webp">CS:APP </p>
<p>It’s been a while since I wrote posts about CMU’s renowned system course 15-213. Last month, I was primarily devoted to my research on SmartNICs and ML for failure detection, and traveling. </p>
<p>Let’s begin phase by phase.</p>
<p>Logistics</p>
<p>The writeup of this lab can be found <a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/attacklab.pdf">here</a> (the CS:APP website). You can <a target="_blank" rel="noopener" href="http://yaoyuncheng.site/wp-content/uploads/2023/07/attacklab.pdf">download it from this blog</a> as well.</p>
<p>The target file can be downloaded from my website as well. Open that using linux tar, or you may change the permissions of the file.</p>
<p><a target="_blank" rel="noopener" href="http://yaoyuncheng.site/wp-content/uploads/2023/07/target1.tar">target1</a><a target="_blank" rel="noopener" href="http://yaoyuncheng.site/wp-content/uploads/2023/07/target1.tar">Download</a></p>
<p>According to my experience, this lab does not work on virtual machines. Bare metal Ubuntu is preferred. I use NYU server instead. </p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-10-at-21.50.11-1024x681.png">Not working on my multi-tenant cloud server</p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-10-at-21.52.03-1024x681.png">Working on NYU bare metal Ubuntu20 server</p>
<p>Non-CMU student, when running the code, should add a <em><strong>-q</strong></em> flag, so that the program will not try to contact the grading service and then failed. </p>
<p><strong>Phase 1: Simple Buffer Overflow Attack</strong></p>
<p>Phase 1 is a very simple buffer overflow attack, and its main idea was went through during the lecture. </p>
<p>First use <em><strong>objdump -d</strong></em> to get the disassembled file, can be .txt or .asm. Then check the disas file. </p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-10-at-21.56.46-1024x591.png"></p>
<p>Use Vim to search for <test>, we find the main logic of phase 1. It calls <getbuf> and then returns. We want to change the return address so that when the execution returns from <getbuf>, it will be redirected to the <touch1> function.</p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-10-at-22.00.24-1024x591.png"><touch1> function has an address of 0x00 00 00 00 00 40 17 c0, and we want to jump to it. </p>
<p>To inject the malicious return address, we first need to know how much buffer the <getbuf> function has allocated. I suggest that you take <em><strong>GDB</strong></em> as your most loyal friend. </p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-10-at-22.05.32-1024x591.png"></p>
<p><strong>Ok, so the <getbuf> allocated 0x28 bytes, which in decimal is 40 bytes. So we first need to fill the 40 bytes buffer with random input, and then the address of the desired function. Remember that the <getbuf> function fills the stack from the smaller address to the bigger one. So it starts filling from the lower right corner to the upper left corner. However, when the program is reading the return address, it reads from the bigger address to the smaller one (reverse direction). With that being said, the injection string could look something like this:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">c0 17 40 00</span><br><span class="line">00 00 00 00</span><br></pre></td></tr></table></figure>
<p>Zsh</p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-10-at-22.14.35-1024x591.png"></p>
<p>Try it, works as expected.</p>
<p><strong>Phase 2: Code injection</strong></p>
<p>This level is a lot more interesting, I have got to say. The biggest challenge for me is to recall the fact that stack grows downwards (from bigger virtual addresses to smaller ones), while the binary code is executed bottom up (from smaller virtual addresses to bigger ones). So remember that in phase 1 we need to reverse the order of out input so that the malicious return address is in the correct order? In this phase, now that we are directly injecting malicious code, we do not need to reverse the order of the code, since they are executed bottom up, in accordance with the order that <getbuf> gets the input from the user, which is also bottom up. However, we still need to reverse the order of the intended virtual addresses, since the input order is the opposite of the way return address is read by the operating system. </p>
<p>Forgive me for speaking too much without giving you an idea what we are doing here. </p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-11-at-11.22.44-1024x921.png"></p>
<p>In this level, we need to redirect the return address of the program to <touch2> but at the same time change the first parameter register %rdi to have value in our cookie.txt, which in our case has the value:</p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-11-at-11.24.29-1024x94.png"></p>
<p>Sounds challenging, right?</p>
<p>The basic idea is that: first we need to change the return address after the <getbuf> procedure to somewhere on the stack (in this question, stack execution protection is disabled), that somewhere should be the place where we input our malicious code, which is the 40 bytes buffer of the <getbuf> function. For convenience, I will just set the return address to the bottom of the stack when the <getbuf> is called, namely the start of the 40 bytes buffer. </p>
<p>Then we need to think about what code we would like to put in the stack we were given. I propose something like this, in assembly of course:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov $0x5561dc98, %rdi</span><br><span class="line">pushq $0x000000004017ec</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>Zsh</p>
<p>The first line puts the cookie into the register that holds the parameter value for procedure <touch2>. The second line push a return address to the stack, and pushq command will also automatically decrement the stack pointer by 8, so that when we execute ret command in the third line, the stack pointer will increment by 8 automatically, and pop the return address out. This 0x4017ec address points to the <touch2> procedure, which can be found out here:</p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-11-at-11.36.16-1024x591.png"></p>
<p>The last piece of this puzzle is, what should the return address of the <getbuf> function be changed to? We want to change it to the beginning of our malicious injected code, which we inject starting at the lowest address of the 40 byte buffer. The answer is self-evident, we need to change the return address to the lowest address of the buffer, and the code will be then executed from bottom up. </p>
<p>So what is this lowest address? I suggest GDB again, your most faithful friend with Linux. </p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-11-at-11.41.42-1024x591.png"></p>
<p>The answer is here, 0x5561dc78!</p>
<p>One last step before putting everything together. What is the binary representation of the assembly that we are injecting? To find out, first compile this assembly, and then objdump -d the output to find out. </p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-11-at-11.44.15-1024x591.png"></p>
<p>Putting everything together, here is what we should input </p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-13.59.03-1024x591.png"></p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-14.01.33-1024x591.png">this is indeed a valid answer for level 2 of the lab.</p>
<p><strong>Phase 3: Advanced Code Injection</strong></p>
<p>This phase is quite formidable, I have got to admit. Let’s first check out the requirement of the question, it gives us a lot of useful hints.</p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-16.59.03-1024x455.png"></p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-16.59.11-1024x777.png"></p>
<p>The code snippet is not entirely easy to understand, because it does seem a little bit whimsical. If you were able to break down the requirement, here is what we need to do:</p>
<ol start="2">
<li><p>jump to <touch3>, which is at address 0x4018fa of the virtual address space</p>
</li>
<li><p>pass the address of the ASCII representation of our cookie to register %rdi, which serves as a parameter when we call the procedure <hexmatch>.</p>
</li>
<li><p>Figure out a safe place within the stack to store the ASCII representation of our cookie, because some portion of the stack may be overwritten by the the code from <hexmatch></p>
</li>
</ol>
<p>It is observable that we first need to figure out (3), i.e. a safe place that will not be overwritten, then figure out the code we inject to the buffer. </p>
<p>So what is the ASCII representation of the cookie, which for us is 0x59b997fa? How many bytes of space do we need to store the ASCII representation of it?</p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-17.09.59-1024x339.png"></p>
<p>It seems that we need 8 bytes of space, and the ASCII code is 35 39 62 39 39 37 66 61.</p>
<p>So which place is safe to store these 8 bytes? In other words, which part of the stack will be overwritten when we call <hexmatch>? GDB will tell us. </p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-17.15.42-1024x653.png"></p>
<p>First, try this input, then check how much of the 11111…1111 buffer space is changed by hexmatch in GDB. The return address is changed by buffer overflow to <touch3> so that we can observe the behavior of <hexmatch>. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># convert hex to raw hex</span><br><span class="line">./hex2raw &lt; p3\_test.txt &gt; p3\_test\_raw.txt</span><br><span class="line"># GDB COMMAND</span><br><span class="line">gdb --args ./ctarget -q</span><br><span class="line">b test</span><br><span class="line">run -q &lt; p3\_test\_raw.txt</span><br><span class="line"># inspect the first 80 bytes starting at a certain address, in hex</span><br><span class="line">x/20x 0x5561dc78</span><br></pre></td></tr></table></figure>
<p>Zsh</p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-17.27.08-1024x653.png"></p>
<p>now that we are in <touch3>, make a breakpoint before and after <hexmatch> to see how much of the buffer has been changed. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b \*0x040190b</span><br><span class="line">(gdb) b \*0x0401916</span><br></pre></td></tr></table></figure>
<p>Zsh</p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-17.28.52-1024x177.png">this is the buffer layout before calling <hexmatch></p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-17.30.37-1024x185.png">this is the buffer layout after calling <hexmatch></p>
<p>we can see that all 40 bytes have been overwritten. So we have to buffer overflow more, and store the address of the ASCII code at someplace after. Address starting at 0x5561dca8 seems unchanged after calling <hexmatch>, and is thus a valid candidate. </p>
<p>So we want to overflow more than the typical 48 bytes. We want at least 56 bytes, and the last 8 bytes are for the ASCII.</p>
<p>Then we need to translate the code using the same technique: write the code, gcc -c, objdump -d</p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-17.37.40-1024x653.png"></p>
<p>You see that we store the address of the ASCII to $rdi, change the return address to <touch3> and then return. </p>
<p>We put the code at the beginning of the buffer, so the return address of <getbuf> should also be changed to 0x5561dc78</p>
<p>Putting everything together, here is the injection code:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">48 c7 c7 a8</span><br><span class="line">dc 61 55 68</span><br><span class="line">fa 18 40 00</span><br><span class="line">c3 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">78 dc 61 55</span><br><span class="line">00 00 00 00</span><br><span class="line">35 39 62 39</span><br><span class="line">39 37 66 61</span><br></pre></td></tr></table></figure>
<p>Zsh</p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-17.40.17-1024x653.png"></p>
<p>test it, it is indeed the answer. </p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-18.10.25-1024x653.png"></p>
<p><strong>Phase 4: Return-Oriented Attacks</strong></p>
<p>This phase is quite easy, takes around 20 minutes to solve (the previous phase takes me hours…)</p>
<p>The key idea is to understand how to use return-oriented programming to inject malicious code. I think that the lab write-up did a pretty decent job, so let me just quote here. </p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.24.57-1024x457.png"></p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.25.17-819x1024.png"></p>
<p>The main difficulty then is to find the appropriate code segments and piece them together. </p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.26.24-1024x581.png"></p>
<p>here is the requirement for this phase. If you are logical enough, here is the stuff that we need to do:</p>
<ol start="2">
<li><p>use popq instruction to put the cookie to %rdi</p>
</li>
<li><p>then jump to the procedure <touch2></p>
</li>
</ol>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.29.16-1024x453.png"></p>
<p>As hinted by the author, here we only use popq and movq. Two gadgets are enough. Now let us take a look at the gadgets available!</p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.30.28-1024x653.png"></p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.30.57-1024x653.png"></p>
<p>We can only use the first 8 gadgets, from the &lt;start_farm&gt; to the &lt;mid_farm&gt;. Apparently, we need a popq to pop the cookie to a certain register, so we are looking for anything from 58 to 5f.</p>
<p>You can choose either &lt;getval_280&gt; or &lt;addval_219&gt;, which contains </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">58 90 c3 </span><br><span class="line">// popq %rax</span><br></pre></td></tr></table></figure>
<p>Zsh</p>
<p>Note that there is no 5f in the code snippet farm, so we cannot pop directly to %rdi. We can however, later move the content from %rax to %rdi. So we are looking for 48 89 c7. &lt;setval_426&gt; provide the segment for that. </p>
<p>I choose &lt;getval_280&gt; and &lt;setval_426&gt;, the first at 0x4019cc, and the latter at 0x4019c5. The <touch2> function is at address 0x4017ec. Putting everything together, we now want the stack to have the following layout, the code bottom being the top of the stack:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">00 00 00 00</span><br><span class="line">00 40 17 ec // touch2 address</span><br><span class="line">00 00 00 00</span><br><span class="line">00 40 19 c5 // mov from %rax to %rdi</span><br><span class="line">00 00 00 00</span><br><span class="line">59 b9 97 fa // my cookie</span><br><span class="line">00 00 00 00</span><br><span class="line">00 40 19 cc // pop to %rax</span><br><span class="line">...... 40 bytes random (the original &lt;getbuf&gt; buffer)</span><br></pre></td></tr></table></figure>
<p>Zsh</p>
<p>in order to achieve that layout, we want out input to be </p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.41.01-1024x653.png"></p>
<p><img src="http://yaoyuncheng.site/wp-content/uploads/2023/07/Screenshot-2023-07-16-at-19.41.27-1024x653.png"></p>
<p>Test it out, and it is indeed the answer. </p>
<p><strong>Phase5</strong> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/07/10/cmu15-213-attack-lab/" data-id="clq6muyg80001agc30xs695rq" data-title="CMU15-213 Attack Lab" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/12/15/hello-world/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Hello World
        
      </div>
    </a>
  
  
    <a href="/2023/05/18/bomb-lab-cmu-15-213/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Bomb Lab CMU 15-213</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/12/15/untitled-post-20231215204346/">None</a>
          </li>
        
          <li>
            <a href="/2023/12/15/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2023/07/10/cmu15-213-attack-lab/">CMU15-213 Attack Lab</a>
          </li>
        
          <li>
            <a href="/2023/05/18/bomb-lab-cmu-15-213/">Bomb Lab CMU 15-213</a>
          </li>
        
          <li>
            <a href="/2023/02/17/paper-reading---cs-model---some-constraints-and-tradeoffs-in-the-design-of-network-communications/">Paper Reading - CS Model - Some constraints and tradeoffs in the design of network communications</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>